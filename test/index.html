<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>新患アンケート</title>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://ajaxzip3.github.io/ajaxzip3.js"></script>

<style>
/* --- 基本設定 --- */
body {
    font-family: sans-serif;
    margin: 0;
    padding: 16px;
    display: block;
    background-color: #f8f9fa;
}

/* --- フォームとローディングの表示制御 --- */
#form {
    display: none; 
    width: 100%;
    max-width: 500px;
    margin: 0 auto 0 0;
}
#loading {
    text-align: center;
    margin-top: 50px;
    font-size: 14px;
    color: #666;
}

h3 {
    text-align: left;
    margin-bottom: 20px;
    border-left: 4px solid #00b900;
    padding-left: 10px;
}

/* 全体のラベル設定（ブロック表示） */
label {
    display: block;
    font-size: 14px;
    font-weight: bold;
    margin-top: 15px;
    margin-bottom: 5px;
}

/* 全体の入力フォーム設定 */
input, textarea, button {
    width: 100%;
    font-size: 16px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
    appearance: none;
}

/* --- ラジオボタン専用のスタイル --- */
.radio-group {
    display: flex;
    gap: 20px;
    margin-top: 8px;
    margin-bottom: 10px;
}

.radio-label {
    display: flex;       
    align-items: center; 
    font-weight: normal; 
    margin: 0;           
    cursor: pointer;
    width: auto;         
}

.radio-label input[type="radio"] {
    width: auto;         
    margin: 0 8px 0 0;   
    appearance: auto;    
}

small {
    display: block;
    font-size: 12px;
    color: #666;
    font-weight: normal;
    margin-top: 2px;
}

button {
    margin-top: 24px;
    padding: 14px;
    background-color: #00b900;
    color: white;
    border: none;
    font-weight: bold;
    cursor: pointer;
}
button:disabled {
    background-color: #ccc !important;
    cursor: not-allowed;
}

/* --- 【追加】言語切り替えスイッチのスタイル --- */
.lang-switch {
    display: flex;
    justify-content: flex-end; /* 右寄せ */
    gap: 15px;
    margin-bottom: 10px;
}
.lang-switch label {
    display: flex;
    align-items: center;
    font-weight: normal;
    font-size: 12px; /* 少し小さめ */
    margin: 0;
    cursor: pointer;
}
.lang-switch input {
    width: auto;
    margin-right: 5px;
    appearance: auto;
}

/* --- カスタムアラート（モーダル） --- */
#custom-alert-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}
#custom-alert-box {
    background: white;
    width: 85%;
    max-width: 320px;
    border-radius: 12px;
    overflow: hidden;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.alert-header {
    background: #f1f1f1;
    padding: 12px;
    font-size: 14px;
    font-weight: bold;
    color: #333;
    border-bottom: 1px solid #ddd;
}
.alert-body {
    padding: 24px 16px;
    font-size: 16px;
    color: #000;
}
.alert-footer {
    border-top: 1px solid #eee;
}
#alert-ok-btn {
    width: 100%;
    border: none;
    background: none;
    color: #007aff;
    font-size: 17px;
    font-weight: bold;
    padding: 12px;
    cursor: pointer;
}
</style>
</head>

<body>

<div id="loading">読み込み中...</div>

<form id="form">
    <div class="lang-switch">
        <label>
            <input type="radio" name="lang" value="ja" checked> 日本語
        </label>
        <label>
            <input type="radio" name="lang" value="en"> English
        </label>
    </div>

    <h3 id="label-title">新患アンケート</h3>

    <label id="label-zip">郵便番号（必須）</label>
    <input type="text" name="zip" required inputmode="numeric" onKeyUp="AjaxZip3.zip2addr(this,'','pref','city','town');">

    <label id="label-pref">都道府県（必須）</label>
    <input type="text" name="pref" required>

    <label id="label-city">市区町村（必須）</label>
    <input type="text" name="city" required>

    <label id="label-town">町名（必須）</label>
    <input type="text" name="town" required>

    <label id="label-addr">番地（必須）</label>
    <input type="text" name="address_number" required>

    <label id="label-bldg">建物名・部屋番号</label>
    <input type="text" name="building">

    <label id="label-name">お名前（必須）</label>
    <input type="text" name="name" required>

    <label id="label-tel">電話番号（必須）</label>
    <input type="tel" name="tel" required placeholder="090-1234-5678" id="input-tel">

    <label id="label-msg-q">
        薬局に事前に伝えておきたいことはありますか？（必須）
        <br>
        <small>（副作用・アレルギー歴、妊娠・授乳の有無 など）</small>
    </label>

    <div class="radio-group">
        <label class="radio-label">
            <input type="radio" name="message_flag" value="none" required>
            <span id="label-none">なし</span>
        </label>
        
        <label class="radio-label">
            <input type="radio" name="message_flag" value="yes">
            <span id="label-yes">あり</span>
        </label>
    </div>

    <textarea
        name="message"
        id="message-textarea"
        rows="3"
        placeholder="例：ペニシリンで発疹が出たことがあります"
        style="display:none; margin-top:8px;"
    ></textarea>
    <input type="hidden" name="line_id_token">

    <button type="submit" id="submit-btn">回答する</button>
</form>

<div id="custom-alert-overlay">
    <div id="custom-alert-box">
        <div class="alert-header">レモン薬局 枚方牧野店</div>
        <div class="alert-body" id="alert-msg-body">回答ありがとうございました</div>
        <div class="alert-footer">
            <button type="button" id="alert-ok-btn">OK</button>
        </div>
    </div>
</div>

<script>
    // --- 【追加】翻訳データと切り替えロジック ---
    const translations = {
        ja: {
            title: "新患アンケート",
            zip: "郵便番号（必須）",
            pref: "都道府県（必須）",
            city: "市区町村（必須）",
            town: "町名（必須）",
            addr: "番地（必須）",
            bldg: "建物名・部屋番号",
            name: "お名前（必須）",
            tel: "電話番号（必須）",
            msg_q: "薬局に事前に伝えておきたいことはありますか？（必須）<br><small>（副作用・アレルギー歴、妊娠・授乳の有無 など）</small>",
            none: "なし",
            yes: "あり",
            ph_tel: "090-1234-5678",
            ph_msg: "例：ペニシリンで発疹が出たことがあります",
            submit: "回答する",
            submit_sending: "送信中...",
            alert_body: "回答ありがとうございました",
            alert_error: "通信エラーが発生しました。もう一度お試しください。"
        },
        en: {
            title: "New Patient Questionnaire",
            zip: "Zip Code (Required)",
            pref: "Prefecture (Required)",
            city: "City (Required)",
            town: "Town (Required)",
            addr: "Street Address (Required)",
            bldg: "Building Name / Room No.",
            name: "Name (Required)",
            tel: "Phone Number (Required)",
            msg_q: "Do you have any information to share with the pharmacy in advance? (Required)<br><small>(Side effects, allergy history, pregnancy/lactation, etc.)</small>",
            none: "None",
            yes: "Yes",
            ph_tel: "090-1234-5678",
            ph_msg: "Ex: I got a rash from penicillin.",
            submit: "Submit",
            submit_sending: "Sending...",
            alert_body: "Thank you for your response.",
            alert_error: "A communication error occurred. Please try again."
        }
    };

    let currentLang = 'ja'; // 現在の言語状態保持

    // 言語切り替えイベントリスナー
    const langRadios = document.querySelectorAll('input[name="lang"]');
    langRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            currentLang = e.target.value;
            changeLanguage(currentLang);
        });
    });

    function changeLanguage(lang) {
        const t = translations[lang];

        // テキストラベルの更新
        document.getElementById('label-title').textContent = t.title;
        document.getElementById('label-zip').textContent = t.zip;
        document.getElementById('label-pref').textContent = t.pref;
        document.getElementById('label-city').textContent = t.city;
        document.getElementById('label-town').textContent = t.town;
        document.getElementById('label-addr').textContent = t.addr;
        document.getElementById('label-bldg').textContent = t.bldg;
        document.getElementById('label-name').textContent = t.name;
        document.getElementById('label-tel').textContent = t.tel;
        
        // innerHTMLを使う（<br>や<small>が含まれるため）
        document.getElementById('label-msg-q').innerHTML = t.msg_q;
        
        document.getElementById('label-none').textContent = t.none;
        document.getElementById('label-yes').textContent = t.yes;
        document.getElementById('alert-msg-body').textContent = t.alert_body;
        
        // ボタン
        const submitBtn = document.getElementById("submit-btn");
        if (!submitBtn.disabled) {
            submitBtn.textContent = t.submit;
        }

        // プレースホルダーの更新
        document.getElementById('input-tel').placeholder = t.ph_tel;
        document.getElementById('message-textarea').placeholder = t.ph_msg;
    }
</script>

<script>
    // ラジオボタンの切り替え処理（あり/なし）
    const radios = document.querySelectorAll('input[name="message_flag"]');
    const messageTextarea = document.getElementById("message-textarea");

    radios.forEach(radio => {
        radio.addEventListener("change", () => {
            if (radio.value === "yes" && radio.checked) {
                // ありの場合は表示して必須にする
                messageTextarea.style.display = "block";
                messageTextarea.required = true;
            } else if (radio.value === "none" && radio.checked) {
                // なしの場合は隠して必須解除＆中身クリア
                messageTextarea.style.display = "none";
                messageTextarea.required = false;
                messageTextarea.value = "";
            }
        });
    });
</script>

<script>
    // UI要素の取得
    const form = document.getElementById("form");
    const loadingDiv = document.getElementById("loading");
    const submitBtn = document.getElementById("submit-btn");
    const alertOverlay = document.getElementById("custom-alert-overlay");
    const alertOkBtn = document.getElementById("alert-ok-btn");

    async function initLiff() {
        try {
            // LIFF IDは元のまま
            await liff.init({ liffId: "2008712193-tMjgLh5i" });

            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }

            // id_token のみ取得
            const idToken = liff.getIDToken();
            document.querySelector('[name="line_id_token"]').value = idToken;

            loadingDiv.style.display = "none";
            form.style.display = "block";

        } catch (err) {
            console.error(err);
            loadingDiv.innerText = "エラーが発生しました。アプリを開き直してください。";
        }
    }

    initLiff();

    form.addEventListener("submit", e => {
        e.preventDefault();

        submitBtn.disabled = true;
        // 現在の言語に合わせて「送信中」のテキストを表示
        submitBtn.innerText = translations[currentLang].submit_sending;

        fetch(
            "https://script.google.com/macros/s/AKfycbxlx3vmMSccfsfhl4eqlch6bs4_Jqv4HfM7MxDxUgtrfehkeMkeLbd5L6HSqQvFau2qrg/exec",
            {
                method: "POST",
                body: new FormData(e.target)
            }
        )
        .then(res => res.text())
        .then(text => {
            console.log("GAS response:", text);
            // 完了時のメッセージも現在の言語に合わせる（すでにHTML側は書き換わっているが、念のため再設定）
            document.getElementById('alert-msg-body').textContent = translations[currentLang].alert_body;
            alertOverlay.style.display = "flex";
        })
        .catch(err => {
            console.error(err);
            alert(translations[currentLang].alert_error); // エラーメッセージも翻訳
            submitBtn.disabled = false;
            submitBtn.innerText = translations[currentLang].submit;
        });
    });

    alertOkBtn.addEventListener("click", () => {
        liff.closeWindow();
    });
</script>

</body>
</html>
