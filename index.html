<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>新患アンケート</title>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://ajaxzip3.github.io/ajaxzip3.js"></script>

<style>
body { font-family: sans-serif; margin: 0; padding: 16px; display: block; background-color: #f8f9fa; }
#form { display: none; width: 100%; max-width: 500px; margin: 0 auto 0 0; }
#loading { text-align: center; margin-top: 50px; font-size: 14px; color: #666; }
h3 { text-align: left; margin-bottom: 20px; border-left: 4px solid #00b900; padding-left: 10px; }
label { display: block; font-size: 14px; font-weight: bold; margin-top: 15px; margin-bottom: 5px; }
input, textarea, button { width: 100%; font-size: 16px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; appearance: none; }
small { display: block; font-size: 12px; color: #666; font-weight: normal; margin-top: 2px; }
button { margin-top: 24px; padding: 14px; background-color: #00b900; color: white; border: none; font-weight: bold; cursor: pointer; }
button:disabled { background-color: #ccc !important; cursor: not-allowed; }

/* アラート用スタイル */
#custom-alert-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
#custom-alert-box { background: white; width: 85%; max-width: 320px; border-radius: 12px; overflow: hidden; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
.alert-header { background: #f1f1f1; padding: 12px; font-size: 14px; font-weight: bold; color: #333; border-bottom: 1px solid #ddd; }
.alert-body { padding: 24px 16px; font-size: 16px; color: #000; }
.alert-footer { border-top: 1px solid #eee; }
#alert-ok-btn { width: 100%; border: none; background: none; color: #007aff; font-size: 17px; font-weight: bold; padding: 12px; cursor: pointer; }
</style>
</head>

<body>

<div id="loading">読み込み中...</div>

<form id="form">
<h3>新患アンケート</h3>

<label>郵便番号（必須）</label>
<input type="text" name="zip" required inputmode="numeric" onKeyUp="AjaxZip3.zip2addr(this,'','pref','city','town');">

<label>都道府県（必須）</label>
<input type="text" name="pref" required>

<label>市区町村（必須）</label>
<input type="text" name="city" required>

<label>町名（必須）</label>
<input type="text" name="town" required>

<label>番地（必須）</label>
<input type="text" name="address_number" required>

<label>建物名・部屋番号</label>
<input type="text" name="building">

<label>お名前（必須）</label>
<input type="text" name="name" required>

<label>電話番号（必須）</label>
<input type="tel" name="tel" required placeholder="090-1234-5678">

<label>
薬局に事前に伝えておきたいことはありますか？
<br>
<small>（副作用・アレルギー歴、妊娠・授乳の有無 など）</small>
</label>
<textarea name="message" rows="3"></textarea>

<input type="hidden" name="line_name">
<input type="hidden" name="id_token">

<button type="submit" id="submit-btn">回答する</button>
</form>

<div id="custom-alert-overlay">
<div id="custom-alert-box">
<div class="alert-header">レモン薬局 枚方牧野店</div>
<div class="alert-body">回答ありがとうございました</div>
<div class="alert-footer">
<button type="button" id="alert-ok-btn">OK</button>
</div>
</div>
</div>

<script>
const form = document.getElementById("form");
const loadingDiv = document.getElementById("loading");
const submitBtn = document.getElementById("submit-btn");
const alertOverlay = document.getElementById("custom-alert-overlay");
const alertOkBtn = document.getElementById("alert-ok-btn");

async function initLiff() {
    try {
        // LIFF IDはご自身のものを使用
        await liff.init({ liffId: "2008712193-tMjgLh5i" });

        if (!liff.isLoggedIn()) {
            liff.login();
            return;
        }

        const profile = await liff.getProfile();
        
        // 変更点: IDトークンを取得してセット
        const idToken = liff.getIDToken();
        
        document.querySelector('[name="line_name"]').value = profile.displayName;
        document.querySelector('[name="id_token"]').value = idToken; // ここにトークンが入ります

        loadingDiv.style.display = "none";
        form.style.display = "block";

    } catch (err) {
        console.error(err);
        loadingDiv.innerText = "エラーが発生しました: " + err.message;
    }
}
initLiff();

form.addEventListener("submit", e => {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.innerText = "送信中...";

    fetch(
        "https://script.google.com/macros/s/AKfycbxlx3vmMSccfsfhl4eqlch6bs4_Jqv4HfM7MxDxUgtrfehkeMkeLbd5L6HSqQvFau2qrg/exec", 
        {
            method: "POST",
            body: new FormData(e.target)
        }
    ).then(() => {
        alertOverlay.style.display = "flex";
    }).catch((err) => {
        alert("通信エラーが発生しました。");
        submitBtn.disabled = false;
        submitBtn.innerText = "回答する";
    });
});

alertOkBtn.addEventListener("click", () => {
    liff.closeWindow();
});
</script>

</body>
</html>
